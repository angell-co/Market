{# This will likely come in as a comma separated string, so we need to split that into an array #}
{% if selectedIds is not iterable %}
    {% set selectedIds = selectedIds|split(',') %}
{% endif %}


{# Process the removed ID if there is one #}
{% if removedId is defined %}
    {% set selectedIds = selectedIds|filter((v, k) => v != removedId) %}
{% endif %}


{# Run the queries for the actual display of the index #}
{% set currentVendor = craft.app.plugins.getPlugin('market').vendors.getCurrentVendor() %}
{% set page = page ?? 1 %}
{% set sort = sort ?? 'dateCreated desc' %}
{% set query = query ?? '' %}

{% set assetsQuery = craft.assets
    .limit(12)
    .search(query)
    .orderBy(sort)
    .folderId(currentVendor.filesFolderId)
%}

{% set pageInfo = sprig.paginate(assetsQuery, page) %}
{% set vendorAssets = pageInfo.pageResults %}

{# Panel middle #}
<div class="flex-grow overflow-y-auto py-6 px-4 sm:px-6">

    {# Search and filters #}
    <div class="grid grid-cols-3 sm:grid-cols-4 gap-4 mb-4">
        {# Search #}
        <div class="col-span-2 sm:col-span-3">
            <label for="query" class="block text-sm font-medium text-gray-700">Search</label>
            <div class="mt-1 relative rounded-md shadow-sm">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    {# Heroicon name: search #}
                    <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                        <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                    </svg>
                </div>
                <input sprig
                       s-trigger="keyup changed delay:250ms"
                       type="text" name="query" id="query"
                       class="block w-full pl-10 sm:text-sm border border-gray-300 focus:border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-brand-500"
                       placeholder="Search files"
                       value="{{ query }}"
                >
            </div>
        </div>

        {# Sort #}
        <div class="col-span-1">
            <label for="sort" class="block text-sm font-medium text-gray-700">Sort</label>
            <select sprig
                    id="sort"
                    name="sort"
                    class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:border-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-brand-500 sm:text-sm rounded-md"
            >
                <option value="title asc" {{ sort == 'title asc' ? 'selected' }}>A-Z</option>
                <option value="title desc" {{ sort == 'title desc' ? 'selected' }}>Z-A</option>
                <option value="dateCreated desc" {{ sort == 'dateCreated desc' ? 'selected' }}>Date Created (↓)</option>
                <option value="dateCreated asc" {{ sort == 'dateCreated asc' ? 'selected' }}>Date Created (↑)</option>
                <option value="dateUpdated desc" {{ sort == 'dateUpdated desc' ? 'selected' }}>Date Updated (↓)</option>
                <option value="dateUpdated asc" {{ sort == 'dateUpdated asc' ? 'selected' }}>Date Updated (↑)</option>
            </select>
        </div>
    </div>

    {% if vendorAssets %}

        {# Results list #}
        <ul class="grid gap-4 grid-cols-3 sm:grid-cols-4">
            {% for vendorAsset in vendorAssets %}

                <li class="col-span-1 flex flex-col">
                    <label for="field-{{ fieldId }}-asset-index-{{ vendorAsset.id }}-checkbox"
                           class="relative cursor-pointer bg-white rounded-md overflow-hidden shadow hover:bg-gray-50">

                        {# Image #}
                        <div class="flex-1 flex flex-col">
                            <div class="aspect-w-1 aspect-h-1">
                                <img class="object-cover" src="{{ vendorAsset.url({ width: 500, height: 500 }) }}" alt="{{ vendorAsset.title }}">
                            </div>
                        </div>

                        {# Checkbox and title #}
                        <div class="flex-1 flex flex-col p-2">
                            <div class="flex items-start">
                                <div class="h-5 flex items-center">
                                    <input sprig
                                           id="field-{{ fieldId }}-asset-index-{{ vendorAsset.id }}-checkbox"
                                           type="checkbox"
                                           value="{{ vendorAsset.id }}"
                                           s-val:page="{{ page }}"
                                           s-val:sort="{{ sort }}"
                                           s-val:query="{{ query }}"
                                           {% if vendorAsset.id in selectedIds %}
                                               checked
                                               s-val:selected-ids="{{ selectedIds|filter(v => v != vendorAsset.id)|join(',') }}"
                                           {% else %}
                                               s-val:selected-ids="{{ selectedIds|push(vendorAsset.id)|join(',') }}"
                                           {% endif %}
                                           {% if selectedIds|length == fieldLimit and vendorAsset.id not in selectedIds %}disabled{% endif %}
                                           class="focus:ring-brand-500 h-4 w-4 text-brand-600 border-gray-300 rounded"
                                    >
                                </div>
                                <div class="ml-3 text-sm truncate">
                                    <span class="font-medium text-gray-700">{{ vendorAsset.title }}</span>
                                </div>
                            </div>
                        </div>
                    </label>
                </li>
            {% endfor %}
        </ul>

        {# Pagination #}
        {% include '_market/_includes/pagination' with {
            vals: {
                'selected-ids': selectedIds|join(',')
            },
            itemType: 'files'
        } %}
    {% elseif query %}

        {# No results #}
        <div class="rounded-md shadow-md bg-red-100 border border-red-300 p-4">
            <div class="flex">
                <div class="flex-shrink-0">
                    {# Heroicon name: emoji-sad #}
                    <svg class="h-5 w-5 text-red-700" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM7 9a1 1 0 100-2 1 1 0 000 2zm7-1a1 1 0 11-2 0 1 1 0 012 0zm-7.536 5.879a1 1 0 001.415 0 3 3 0 014.242 0 1 1 0 001.415-1.415 5 5 0 00-7.072 0 1 1 0 000 1.415z" clip-rule="evenodd" />
                    </svg>
                </div>
                <div class="ml-3">
                    <h3 class="text-sm font-medium text-red-800">
                        Oh no!
                    </h3>
                    <div class="mt-2 text-sm text-red-700 space-y-2">
                        <p>We couldn’t find anything for <strong>“{{ query }}”</strong>, try being less specific or using different keywords.</p>
                    </div>
                    <div class="mt-4">
                        <div class="-mx-2 -my-1.5 flex">
                            <button sprig
                                    s-val:query=""
                                    type="button"
                                    class="bg-red-100 px-2 py-1.5 rounded-md text-sm font-medium text-red-800 hover:bg-red-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-red-100 focus:ring-red-600"
                            >
                                Reset search
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    {% else %}
        {# No assets at all yet #}
        <div class="rounded-md shadow-md bg-orange-100 border border-orange-300 p-4">
            <div class="flex">
                <div class="flex-shrink-0">
                    {# Heroicon name: light-bulb #}
                    <svg class="h-5 w-5 text-orange-700" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                        <path d="M11 3a1 1 0 10-2 0v1a1 1 0 102 0V3zM15.657 5.757a1 1 0 00-1.414-1.414l-.707.707a1 1 0 001.414 1.414l.707-.707zM18 10a1 1 0 01-1 1h-1a1 1 0 110-2h1a1 1 0 011 1zM5.05 6.464A1 1 0 106.464 5.05l-.707-.707a1 1 0 00-1.414 1.414l.707.707zM5 10a1 1 0 01-1 1H3a1 1 0 110-2h1a1 1 0 011 1zM8 16v-1h4v1a2 2 0 11-4 0zM12 14c.015-.34.208-.646.477-.859a4 4 0 10-4.954 0c.27.213.462.519.476.859h4.002z" />
                    </svg>
                </div>
                <div class="ml-3">
                    <h3 class="text-sm font-medium text-orange-800">
                        Nothing here …
                    </h3>
                    <div class="mt-2 text-sm text-orange-700 space-y-2">
                        <p>You don’t have any files yet, go ahead and add some!</p>
                    </div>
                    <div class="mt-4">
                        <div class="-mx-2 -my-1.5 flex">
                            <button type="button" class="bg-orange-100 px-2 py-1.5 rounded-md text-sm font-medium text-orange-800 hover:bg-orange-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-orange-100 focus:ring-orange-600">
                                Upload
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}
</div>

{# Panel footer #}
<div class="flex-shrink-0 flex justify-between py-6 px-4 sm:px-6">
    <form id="field-{{ fieldId }}-uploader"
          sprig
          s-method="post"
          s-action="assets/upload"
          s-trigger="change"
          s-indicator="#field-{{ fieldId }}-asset-index"
          hx-encoding="multipart/form-data"
          hx-ext="asset-uploader"
          class="flex justify-start"
    >

        {{ hiddenInput('folderId', currentVendor.filesFolderId) }}

        <div>
            <label for="field-{{ fieldId }}-uploader-input" class="block bg-white py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                <span>Upload a file</span>
                <input id="field-{{ fieldId }}-uploader-input" type="file" name="assets-upload" class="sr-only">
            </label>
        </div>

        <div>
            <div class="h-3 relative w-20 rounded-full overflow-hidden">
                <div class="w-full h-full bg-gray-200 absolute"></div>
                <div id="field-{{ fieldId }}-uploader-progress" class="h-full bg-green-500 relative w-0"></div>
            </div>
        </div>
    </form>

    <div>
        {# TODO: finish this #}
        <div class="htmx-indicator inline-block">
            <svg class="animate-spin h-5 w-5 text-brand-700" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
        </div>
        <button x-on:click.prevent="open = false"
                type="button"
                class="ml-4 bg-white py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
        >
            Cancel
        </button>
        <button sprig
                s-val:selected-ids="{{ selectedIds|join(',') }}"
                s-swap="none"
                s-indicator="#field-{{ fieldId }}"
                x-on:click="open = false"
                id="field-{{ fieldId }}-asset-index-save"
                type="button"
                class="ml-4 py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
        >
            Save
        </button>
    </div>
</div>

<script>

    // Send the selected IDs to the parent component
    htmx.on('#field-{{ fieldId }}-asset-index-save', 'click', function(evt) {
        htmx.find('#field-{{ fieldId }}-selectedIds').value = "{{ selectedIds|join(',') }}";
        htmx.trigger('#field-{{ fieldId }}', 'refresh');
    });

    // Add the asset uploader extension
    htmx.defineExtension('asset-uploader', {
        onEvent : function(name, evt) {
            // Stop the processing at this point
            if (name === 'htmx:beforeOnLoad') {
                evt.preventDefault();
                evt.stopPropagation();

                // Trigger a refresh of only the asset index
                htmx.trigger('#field-{{ fieldId }}-asset-index', 'refresh');
                return false;
            }
        }
    });

    // Progress bar on upload
    htmx.on('#field-{{ fieldId }}-uploader', 'htmx:xhr:progress', function(evt) {
        var percent = evt.detail.loaded/evt.detail.total * 100;
        htmx.find('#field-{{ fieldId }}-uploader-progress').style.width = percent+'%';
    });
</script>
